<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Field Verification</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Lucide React Icons as inline SVG components
        const Camera = ({ className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                <circle cx="12" cy="13" r="3"/>
            </svg>
        );

        const FileText = ({ className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10 9 9 9 8 9"/>
            </svg>
        );

        const Plus = ({ className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        );

        const Trash2 = ({ className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
        );

        const Download = ({ className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
        );

        const Upload = ({ className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
        );

        const CheckCircle = ({ className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        );

        const AlertCircle = ({ className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
        );

        const Save = ({ className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                <polyline points="17 21 17 13 7 13 7 21"/>
                <polyline points="7 3 7 8 15 8"/>
            </svg>
        );

        function App() {
            // Load saved data from localStorage
            const loadSavedData = () => {
                try {
                    const saved = localStorage.getItem('constructionVerificationData');
                    if (saved) {
                        return JSON.parse(saved);
                    }
                } catch (error) {
                    console.error('Error loading saved data:', error);
                }
                return null;
            };

            const savedData = loadSavedData();

            const [project, setProject] = useState(savedData?.project || {
                name: '',
                payAppDate: new Date().toISOString().split('T')[0],
                periodStart: '',
                periodEnd: '',
                observationDate: new Date().toISOString().split('T')[0]
            });
            const [items, setItems] = useState(savedData?.items || []);
            const [photos, setPhotos] = useState(savedData?.photos || {});
            const [notes, setNotes] = useState(savedData?.notes || {});
            const [uploadingPdf, setUploadingPdf] = useState(false);
            const [pdfError, setPdfError] = useState('');
            const [showBulkAdd, setShowBulkAdd] = useState(false);
            const [bulkText, setBulkText] = useState('');
            const pdfInputRef = useRef(null);
            const importInputRef = useRef(null);

            // Auto-save to localStorage whenever data changes
            useEffect(() => {
                try {
                    const dataToSave = {
                        project,
                        items,
                        photos,
                        notes,
                        lastSaved: new Date().toISOString()
                    };
                    localStorage.setItem('constructionVerificationData', JSON.stringify(dataToSave));
                } catch (error) {
                    console.error('Error saving data:', error);
                }
            }, [project, items, photos, notes]);

            // Export project to JSON file
            const exportProject = () => {
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    project,
                    items,
                    photos,
                    notes
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const fileName = `${project.name.replace(/\s+/g, '_') || 'Verification_Project'}_${new Date().toISOString().split('T')[0]}.json`;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('Project exported! Save this file to continue later.');
            };

            // Import project from JSON file
            const importProject = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        if (!importData.project || !importData.items) {
                            throw new Error('Invalid project file format');
                        }
                        
                        if (items.length > 0 || project.name) {
                            if (!confirm('This will replace your current project. Continue?')) {
                                return;
                            }
                        }
                        
                        setProject(importData.project);
                        setItems(importData.items || []);
                        setPhotos(importData.photos || {});
                        setNotes(importData.notes || {});
                        
                        alert(`Project "${importData.project.name}" loaded successfully!`);
                    } catch (error) {
                        alert('Error loading project file. Please make sure it\'s a valid export.');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            // Clear all data
            const clearAllData = () => {
                if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                    localStorage.removeItem('constructionVerificationData');
                    setProject({
                        name: '',
                        payAppDate: new Date().toISOString().split('T')[0],
                        periodStart: '',
                        periodEnd: '',
                        observationDate: new Date().toISOString().split('T')[0]
                    });
                    setItems([]);
                    setPhotos({});
                    setNotes({});
                    alert('All data cleared!');
                }
            };

            const extractTextFromPDF = async (file) => {
                setUploadingPdf(true);
                setPdfError('');
                console.log('Starting PDF extraction...');
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);
                    
                    let binary = '';
                    const len = uint8Array.byteLength;
                    for (let i = 0; i < len; i++) {
                        binary += String.fromCharCode(uint8Array[i]);
                    }
                    const base64 = btoa(binary);
                    console.log('PDF converted to base64, size:', base64.length);

                    console.log('Calling /api/extract-pdf...');
                    const response = await fetch('/api/extract-pdf', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ base64Data: base64 })
                    });

                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error:', errorText);
                        throw new Error(`Function failed: ${response.status} - ${errorText}`);
                    }

                    const data = await response.json();
                    console.log('API Response:', data);

                    if (data.content && data.content.length > 0) {
                        let textContent = '';
                        for (const block of data.content) {
                            if (block.type === 'text') textContent += block.text;
                        }
                        console.log('Extracted text content:', textContent.substring(0, 200) + '...');

                        textContent = textContent.trim().replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

                        const parsed = JSON.parse(textContent);
                        console.log('Parsed JSON:', parsed);

                        if (parsed.projectInfo) {
                            setProject(prev => ({
                                ...prev,
                                name: parsed.projectInfo.name || prev.name,
                                payAppDate: parsed.projectInfo.payAppDate || prev.payAppDate,
                                periodStart: parsed.projectInfo.periodStart || prev.periodStart,
                                periodEnd: parsed.projectInfo.periodEnd || prev.periodEnd
                            }));
                            console.log('Project info updated');
                        }

                        if (parsed.lineItems && Array.isArray(parsed.lineItems)) {
                            console.log('Total line items from API:', parsed.lineItems.length);
                            
                            const cleanValue = (val) => {
                                const cleaned = (val || '').toString().replace(/[$,]/g, '').trim();
                                return parseFloat(cleaned) || 0;
                            };

                            const newItems = parsed.lineItems
                                .filter(item => {
                                    const workThisPeriod = cleanValue(item.workCompletedThisPeriod);
                                    const include = item.needsVerification !== false && workThisPeriod > 0;
                                    if (!include) {
                                        console.log(`Filtering out: ${item.description} (workThisPeriod: ${workThisPeriod})`);
                                    }
                                    return include;
                                })
                                .map((item, idx) => ({
                                    id: Date.now() + idx,
                                    description: item.description || '',
                                    workCompletedThisPeriod: String(item.workCompletedThisPeriod || ''),
                                    valueRequested: String(item.valueRequested || ''),
                                    completed: false
                                }));
                            
                            console.log('Filtered items:', newItems.length);
                            console.log('Items to add:', newItems);
                            setItems(newItems);
                            setPdfError('');
                        } else {
                            console.error('No lineItems in parsed data');
                            setPdfError('No line items found in PDF');
                        }
                    } else {
                        console.error('No content in API response');
                        setPdfError('No content returned from API');
                    }

                    setUploadingPdf(false);
                    console.log('PDF extraction complete');
                } catch (err) {
                    console.error('Extraction error:', err);
                    setPdfError('Extraction error: ' + err.message);
                    setUploadingPdf(false);
                }
            };

            const handlePdfUpload = (e) => {
                const file = e.target.files[0];
                if (file && file.type === 'application/pdf') {
                    extractTextFromPDF(file);
                } else {
                    setPdfError('Please upload a valid PDF file');
                }
            };

            const addItem = () => {
                const newItem = {
                    id: Date.now(),
                    description: '',
                    workCompletedThisPeriod: '',
                    valueRequested: '',
                    completed: false
                };
                setItems([...items, newItem]);
            };

            const parseBulkText = () => {
                const lines = bulkText.split('\n').filter(line => line.trim());
                const newItems = [];
                
                lines.forEach(line => {
                    const parts = line.split('|').map(p => p.trim());
                    
                    if (parts.length >= 1) {
                        newItems.push({
                            id: Date.now() + Math.random(),
                            description: parts[0] || '',
                            workCompletedThisPeriod: parts[1] || '',
                            valueRequested: parts[2] || '',
                            completed: false
                        });
                    }
                });
                
                if (newItems.length > 0) {
                    setItems([...items, ...newItems]);
                    setBulkText('');
                    setShowBulkAdd(false);
                }
            };

            const updateItem = (id, field, value) => {
                setItems(items.map(item => 
                    item.id === id ? { ...item, [field]: value } : item
                ));
            };

            const deleteItem = (id) => {
                setItems(items.filter(item => item.id !== id));
                const newPhotos = { ...photos };
                const newNotes = { ...notes };
                delete newPhotos[id];
                delete newNotes[id];
                setPhotos(newPhotos);
                setNotes(newNotes);
            };

            const handlePhotoCapture = (e, itemId) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        setPhotos(prev => ({
                            ...prev,
                            [itemId]: [...(prev[itemId] || []), {
                                url: event.target.result,
                                name: file.name,
                                date: new Date().toLocaleString()
                            }]
                        }));
                    };
                    reader.readAsDataURL(file);
                });
            };

            const deletePhoto = (itemId, photoIndex) => {
                setPhotos(prev => ({
                    ...prev,
                    [itemId]: prev[itemId].filter((_, idx) => idx !== photoIndex)
                }));
            };

            const generatePDFReport = () => {
                const verifiedItems = items.filter(i => i.completed === true);
                
                if (verifiedItems.length === 0) {
                    alert('No items have been verified yet. Please check the "Work Verified & Complete" box for items you want to include in the report.');
                    return;
                }
                
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    alert('PDF library is still loading. Please wait a moment and try again.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                let yPos = margin;

                const checkPageBreak = (neededSpace) => {
                    if (yPos + neededSpace > pageHeight - margin) {
                        doc.addPage();
                        yPos = margin;
                        return true;
                    }
                    return false;
                };

                const formatCurrency = (val) => {
                    const num = parseFloat((val || '').toString().replace(/[$,]/g, ''));
                    return isNaN(num) ? '$0.00' : `$${num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                };

                // Header
                doc.setFontSize(20);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'bold');
                doc.text('FIELD VERIFICATION REPORT', margin, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 10;
                
                doc.setFontSize(9);
                doc.text(`Generated: ${new Date().toLocaleString()}`, margin, yPos);
                yPos += 10;
                
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 8;

                // Project Info
                doc.setFontSize(10);
                doc.text(`Project: ${project.name || 'Not specified'}`, margin, yPos);
                yPos += 7;
                doc.text(`Pay Application Date: ${project.payAppDate}`, margin, yPos);
                yPos += 7;
                doc.text(`Period: ${project.periodStart || 'N/A'} to ${project.periodEnd || 'N/A'}`, margin, yPos);
                yPos += 7;
                doc.text(`Observation Date: ${project.observationDate}`, margin, yPos);
                yPos += 10;
                
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 8;

                // Summary
                checkPageBreak(30);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('VERIFICATION SUMMARY', margin, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 7;
                
                doc.setFontSize(9);
                doc.text(`Items Verified: ${verifiedItems.length} | Total Items: ${items.length}`, margin, yPos);
                yPos += 10;
                
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 8;

                // Verified Items
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('VERIFIED ITEMS', margin, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 8;

                verifiedItems.forEach((item, idx) => {
                    let itemHeight = 40;
                    if (notes[item.id]) itemHeight += 10;
                    if (photos[item.id] && photos[item.id].length > 0) {
                        itemHeight += Math.ceil(photos[item.id].length / 2) * 60;
                    }
                    
                    checkPageBreak(itemHeight);
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${idx + 1}. ${item.description || 'Untitled Item'}`.substring(0, 80), margin, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 6;
                    
                    doc.setFontSize(9);
                    doc.text(`Work This Period: `, margin, yPos);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${formatCurrency(item.workCompletedThisPeriod)}`, margin + 35, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 5;
                    
                    doc.setFontSize(8);
                    doc.text(`Value Requested: ${formatCurrency(item.valueRequested)}`, margin, yPos);
                    yPos += 5;
                    
                    doc.setTextColor(0, 128, 0);
                    doc.text('âœ“ Field Verified', margin, yPos);
                    doc.setTextColor(0, 0, 0);
                    yPos += 8;
                    
                    if (notes[item.id]) {
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'bold');
                        doc.text('Notes:', margin, yPos);
                        doc.setFont(undefined, 'normal');
                        yPos += 5;
                        const noteLines = doc.splitTextToSize(notes[item.id], pageWidth - 2 * margin);
                        doc.text(noteLines, margin, yPos);
                        yPos += noteLines.length * 5;
                    }
                    
                    if (photos[item.id] && photos[item.id].length > 0) {
                        yPos += 3;
                        const photoWidth = 70;
                        const photoHeight = 52;
                        let xOffset = margin;
                        let photoCount = 0;
                        
                        photos[item.id].forEach((photo, pIdx) => {
                            if (photoCount === 2) {
                                yPos += photoHeight + 5;
                                xOffset = margin;
                                photoCount = 0;
                                checkPageBreak(photoHeight + 10);
                            }
                            
                            try {
                                doc.addImage(photo.url, 'JPEG', xOffset, yPos, photoWidth, photoHeight);
                            } catch (e) {
                                console.error('Error adding photo to PDF:', e);
                            }
                            
                            xOffset += photoWidth + 10;
                            photoCount++;
                        });
                        
                        if (photoCount > 0) {
                            yPos += photoHeight + 5;
                        }
                    }
                    
                    yPos += 3;
                    doc.setDrawColor(220, 220, 220);
                    doc.line(margin, yPos, pageWidth - margin, yPos);
                    yPos += 8;
                });

                // Architect's Certification
                checkPageBreak(80);
                
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 8;
                
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'bold');
                doc.text("ARCHITECT'S CERTIFICATION", margin, yPos);
                doc.setFont(undefined, 'normal');
                
                doc.setFontSize(8);
                yPos += 7;
                
                const certText = [
                    'SCOPE OF OBSERVATION:',
                    `This report documents observations conducted on ${project.observationDate}. The architect's observations are limited to readily visible conditions.`,
                    '',
                    'VERIFIED WORK: I have visited the site and observed the construction work identified as verified items.',
                    '',
                    'LIMITATIONS: This observation does not constitute a warranty. The architect has not verified quantities through detailed testing.'
                ];
                
                certText.forEach(line => {
                    if (line === '') {
                        yPos += 3;
                    } else {
                        const lines = doc.splitTextToSize(line, pageWidth - 2 * margin);
                        doc.text(lines, margin, yPos);
                        yPos += lines.length * 4;
                    }
                });
                
                yPos += 10;
                doc.text('_____________________________________', margin, yPos);
                yPos += 5;
                doc.text("Architect's Signature", margin, yPos);
                yPos += 7;
                doc.text(`Date: ${new Date().toLocaleDateString()}`, margin, yPos);

                // Page numbers
                const totalPages = doc.internal.pages.length - 1;
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(
                        `Page ${i} of ${totalPages}`,
                        pageWidth / 2,
                        pageHeight - 10,
                        { align: 'center' }
                    );
                }

                const fileName = `Verification_${project.name.replace(/\s+/g, '_')}_${project.payAppDate}.pdf`;
                doc.save(fileName);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between mb-6">
                                <div className="flex items-center gap-3">
                                    <FileText className="w-8 h-8 text-blue-600" />
                                    <h1 className="text-3xl font-bold text-gray-800">Field Verification</h1>
                                </div>
                                <div className="text-xs text-gray-500">
                                    Auto-saved {savedData?.lastSaved ? new Date(savedData.lastSaved).toLocaleTimeString() : 'never'}
                                </div>
                            </div>

                            <div className="space-y-4 mb-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                                    <input
                                        type="text"
                                        placeholder="Enter project name"
                                        value={project.name}
                                        onChange={(e) => setProject({...project, name: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Pay App Date</label>
                                        <input
                                            type="date"
                                            value={project.payAppDate}
                                            onChange={(e) => setProject({...project, payAppDate: e.target.value})}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Observation Date</label>
                                        <input
                                            type="date"
                                            value={project.observationDate}
                                            onChange={(e) => setProject({...project, observationDate: e.target.value})}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        />
                                    </div>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Pay App Period</label>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <input
                                                type="date"
                                                placeholder="Period Start"
                                                value={project.periodStart}
                                                onChange={(e) => setProject({...project, periodStart: e.target.value})}
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            />
                                        </div>
                                        <div>
                                            <input
                                                type="date"
                                                placeholder="Period End"
                                                value={project.periodEnd}
                                                onChange={(e) => setProject({...project, periodEnd: e.target.value})}
                                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="border-t pt-6 mb-6">
                                <div className="flex flex-wrap gap-3">
                                    <input
                                        ref={pdfInputRef}
                                        type="file"
                                        accept="application/pdf"
                                        onChange={handlePdfUpload}
                                        className="hidden"
                                    />
                                    <button
                                        onClick={() => pdfInputRef.current?.click()}
                                        disabled={uploadingPdf}
                                        className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50"
                                    >
                                        <Upload className="w-5 h-5" />
                                        {uploadingPdf ? 'Extracting...' : 'Upload Pay App PDF'}
                                    </button>
                                    
                                    <button
                                        onClick={() => setShowBulkAdd(!showBulkAdd)}
                                        className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                                    >
                                        <Plus className="w-5 h-5" />
                                        Quick Add Items
                                    </button>
                                    
                                    <button
                                        onClick={addItem}
                                        className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        <Plus className="w-5 h-5" />
                                        Add Single Item
                                    </button>
                                    
                                    <button
                                        onClick={generatePDFReport}
                                        disabled={items.length === 0}
                                        className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50"
                                    >
                                        <Download className="w-5 h-5" />
                                        Generate PDF Report
                                    </button>
                                </div>

                                <div className="flex flex-wrap gap-3 mt-3">
                                    <button
                                        onClick={exportProject}
                                        className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm"
                                    >
                                        <Save className="w-4 h-4" />
                                        Export Project
                                    </button>
                                    
                                    <input
                                        ref={importInputRef}
                                        type="file"
                                        accept="application/json"
                                        onChange={importProject}
                                        className="hidden"
                                    />
                                    <button
                                        onClick={() => importInputRef.current?.click()}
                                        className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm"
                                    >
                                        <Upload className="w-4 h-4" />
                                        Import Project
                                    </button>
                                    
                                    <button
                                        onClick={clearAllData}
                                        className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm"
                                    >
                                        <Trash2 className="w-4 h-4" />
                                        Clear All Data
                                    </button>
                                </div>

                                {pdfError && (
                                    <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                                        <div className="flex items-start gap-2">
                                            <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
                                            <div className="text-sm text-red-800">{pdfError}</div>
                                        </div>
                                    </div>
                                )}

                                {showBulkAdd && (
                                    <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                                        <h3 className="font-semibold mb-2">Quick Add Items</h3>
                                        <p className="text-sm text-gray-600 mb-3">
                                            Enter items (one per line). Format: Description | Work This Period | Value Requested
                                        </p>
                                        <textarea
                                            value={bulkText}
                                            onChange={(e) => setBulkText(e.target.value)}
                                            placeholder="Example:
Material Installation | 5000 | 15000
Equipment Setup | 3000 | 8000"
                                            className="w-full h-32 px-3 py-2 border border-gray-300 rounded-lg"
                                        />
                                        <div className="flex gap-2 mt-3">
                                            <button
                                                onClick={parseBulkText}
                                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                            >
                                                Add Items
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setShowBulkAdd(false);
                                                    setBulkText('');
                                                }}
                                                className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="space-y-4">
                            {items.length === 0 ? (
                                <div className="bg-white rounded-lg shadow p-8 text-center text-gray-500">
                                    <FileText className="w-16 h-16 mx-auto mb-4 opacity-50" />
                                    <p>No verification items yet. Add items manually or upload a pay application PDF.</p>
                                    <p className="text-sm mt-2">Only items requiring field verification will be included.</p>
                                </div>
                            ) : (
                                items.map((item) => (
                                    <div key={item.id} className="bg-white rounded-lg shadow-lg p-6">
                                        <div className="flex items-start gap-4 mb-4">
                                            <div className="flex-1">
                                                <label className="block text-xs font-medium text-gray-600 mb-1">Item Description</label>
                                                <input
                                                    type="text"
                                                    placeholder="Enter item description"
                                                    value={item.description}
                                                    onChange={(e) => updateItem(item.id, 'description', e.target.value)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg font-semibold"
                                                />
                                                
                                                <div className="grid grid-cols-2 gap-4 mt-3">
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1">Work Completed This Period</label>
                                                        <input
                                                            type="text"
                                                            placeholder="$0.00"
                                                            value={item.workCompletedThisPeriod}
                                                            onChange={(e) => updateItem(item.id, 'workCompletedThisPeriod', e.target.value)}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1">Value Requested</label>
                                                        <input
                                                            type="text"
                                                            placeholder="$0.00"
                                                            value={item.valueRequested}
                                                            onChange={(e) => updateItem(item.id, 'valueRequested', e.target.value)}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                        />
                                                    </div>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => deleteItem(item.id)}
                                                className="ml-4 p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                            >
                                                <Trash2 className="w-5 h-5" />
                                            </button>
                                        </div>

                                        <div className="flex items-center gap-2 mb-4 p-3 bg-gray-50 rounded-lg">
                                            <input
                                                type="checkbox"
                                                id={`complete-${item.id}`}
                                                checked={item.completed}
                                                onChange={(e) => updateItem(item.id, 'completed', e.target.checked)}
                                                className="w-5 h-5 text-green-600 rounded focus:ring-2 focus:ring-green-500"
                                            />
                                            <label htmlFor={`complete-${item.id}`} className="flex items-center gap-2 cursor-pointer">
                                                <CheckCircle className={`w-5 h-5 ${item.completed ? 'text-green-600' : 'text-gray-400'}`} />
                                                <span className="text-gray-700 font-medium">Work Verified & Complete</span>
                                            </label>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    <Camera className="w-4 h-4 inline mr-2" />
                                                    Verification Photos
                                                </label>
                                                <div className="flex gap-2 mb-3">
                                                    <label className="flex-1 cursor-pointer">
                                                        <input
                                                            type="file"
                                                            accept="image/*"
                                                            multiple
                                                            capture="environment"
                                                            onChange={(e) => handlePhotoCapture(e, item.id)}
                                                            className="hidden"
                                                        />
                                                        <div className="flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-semibold">
                                                            <Camera className="w-4 h-4" />
                                                            Take Photo
                                                        </div>
                                                    </label>
                                                    <label className="flex-1 cursor-pointer">
                                                        <input
                                                            type="file"
                                                            accept="image/*"
                                                            multiple
                                                            onChange={(e) => handlePhotoCapture(e, item.id)}
                                                            className="hidden"
                                                        />
                                                        <div className="flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-semibold">
                                                            <Upload className="w-4 h-4" />
                                                            Upload
                                                        </div>
                                                    </label>
                                                </div>
                                                {photos[item.id] && photos[item.id].length > 0 && (
                                                    <div className="grid grid-cols-2 gap-2">
                                                        {photos[item.id].map((photo, idx) => (
                                                            <div key={idx} className="relative group">
                                                                <img 
                                                                    src={photo.url} 
                                                                    alt={`Photo ${idx + 1}`}
                                                                    className="w-full h-32 object-cover rounded-lg border border-gray-300"
                                                                />
                                                                <button
                                                                    onClick={() => deletePhoto(item.id, idx)}
                                                                    className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                                                                >
                                                                    <Trash2 className="w-4 h-4" />
                                                                </button>
                                                                <div className="text-xs text-gray-500 mt-1">{photo.date}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Observation Notes
                                                </label>
                                                <textarea
                                                    value={notes[item.id] || ''}
                                                    onChange={(e) => setNotes({...notes, [item.id]: e.target.value})}
                                                    placeholder="Add field observations, issues, or notes..."
                                                    className="w-full h-32 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
