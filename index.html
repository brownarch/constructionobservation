<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construction Observation App</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useRef } = React;
    const { Camera, Mic, FileText, Plus, Trash2, Download, Upload, CheckCircle, FileUp, AlertCircle } = lucide;
    const { jsPDF } = window.jspdf;

    function ConstructionObservationApp() {
      const [project, setProject] = useState({
        name: '',
        payAppDate: new Date().toISOString().split('T')[0],
        periodStart: '',
        periodEnd: '',
        observationDate: new Date().toISOString().split('T')[0]
      });
      const [items, setItems] = useState([]);
      const [photos, setPhotos] = useState({});
      const [notes, setNotes] = useState({});
      const [uploadingPdf, setUploadingPdf] = useState(false);
      const [pdfError, setPdfError] = useState('');
      const [extractionInstructions, setExtractionInstructions] = useState('');
      const [showBulkAdd, setShowBulkAdd] = useState(false);
      const [bulkText, setBulkText] = useState('');
      const pdfInputRef = useRef(null);

      const extractTextFromPDF = async (file) => {
        setUploadingPdf(true);
        setPdfError('');
        
        try {
          const arrayBuffer = await file.arrayBuffer();
          const uint8Array = new Uint8Array(arrayBuffer);
          
          let binary = '';
          const len = uint8Array.byteLength;
          for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(uint8Array[i]);
          }
          const base64 = btoa(binary);

          const response = await fetch('/api/extract-pdf', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              base64Data: base64
            })
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error('API Error Response:', errorText);
            throw new Error(`API request failed: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          console.log('API Response:', data);

          if (data.content && data.content.length > 0) {
            let textContent = '';
            
            for (const block of data.content) {
              if (block.type === 'text') {
                textContent += block.text;
              }
            }

            console.log('Extracted text:', textContent);

            textContent = textContent.trim();
            textContent = textContent.replace(/```json\n?/g, '');
            textContent = textContent.replace(/```\n?/g, '');
            textContent = textContent.trim();

            try {
              const parsed = JSON.parse(textContent);
              console.log('Parsed JSON:', parsed);

              if (parsed.projectInfo) {
                setProject(prev => ({
                  ...prev,
                  name: parsed.projectInfo.name || prev.name,
                  payAppDate: parsed.projectInfo.payAppDate || prev.payAppDate,
                  periodStart: parsed.projectInfo.periodStart || prev.periodStart,
                  periodEnd: parsed.projectInfo.periodEnd || prev.periodEnd
                }));
              }

              if (parsed.lineItems && Array.isArray(parsed.lineItems)) {
                const newItems = parsed.lineItems.map((item, idx) => ({
                  id: Date.now() + idx,
                  description: item.description || '',
                  scheduledValue: String(item.scheduledValue || ''),
                  workCompleted: String(item.workCompleted || ''),
                  percentComplete: String(item.percentComplete || ''),
                  completed: false
                }));
                
                setItems(newItems);
                setPdfError('');
              } else {
                throw new Error('No line items found in response');
              }

            } catch (parseError) {
              console.error('JSON Parse Error:', parseError);
              console.error('Text that failed to parse:', textContent);
              throw new Error('Could not parse the extracted data. The PDF may have an unusual format.');
            }

          } else {
            throw new Error('No content returned from API');
          }

          setUploadingPdf(false);

        } catch (error) {
          console.error('Extraction error:', error);
          setPdfError(error.message || 'Failed to extract data from PDF');
          
          setExtractionInstructions(`
I apologize - the automatic extraction is having issues. Here's a workaround:

1. I can help extract the data if you upload the PDF to our chat (outside this app)
2. I'll read it and give you the data in a format you can paste
3. Then you can use the "Quick Add" feature in the app

Would you like to try that approach? Just send me the PDF in our conversation.
          `);
          
          setUploadingPdf(false);
        }
      };

      const handlePdfUpload = (e) => {
        const file = e.target.files[0];
        if (file && file.type === 'application/pdf') {
          extractTextFromPDF(file);
        } else {
          setPdfError('Please upload a valid PDF file');
        }
      };

      const addItem = () => {
        const newItem = {
          id: Date.now(),
          description: '',
          scheduledValue: '',
          workCompleted: '',
          percentComplete: '',
          completed: false
        };
        setItems([...items, newItem]);
      };

      const parseBulkText = () => {
        const lines = bulkText.split('\n').filter(line => line.trim());
        const newItems = [];
        
        lines.forEach(line => {
          const parts = line.split('|').map(p => p.trim());
          
          if (parts.length >= 1) {
            newItems.push({
              id: Date.now() + Math.random(),
              description: parts[0] || '',
              scheduledValue: parts[1] || '',
              workCompleted: parts[2] || '',
              percentComplete: parts[3] || '',
              completed: false
            });
          }
        });
        
        if (newItems.length > 0) {
          setItems([...items, ...newItems]);
          setBulkText('');
          setShowBulkAdd(false);
        }
      };

      const updateItem = (id, field, value) => {
        setItems(items.map(item => 
          item.id === id ? { ...item, [field]: value } : item
        ));
      };

      const deleteItem = (id) => {
        setItems(items.filter(item => item.id !== id));
        const newPhotos = { ...photos };
        const newNotes = { ...notes };
        delete newPhotos[id];
        delete newNotes[id];
        setPhotos(newPhotos);
        setNotes(newNotes);
      };

      const handlePhotoCapture = (e, itemId) => {
        const files = Array.from(e.target.files);
        files.forEach(file => {
          const reader = new FileReader();
          reader.onload = (event) => {
            setPhotos(prev => ({
              ...prev,
              [itemId]: [...(prev[itemId] || []), {
                url: event.target.result,
                name: file.name,
                date: new Date().toLocaleString()
              }]
            }));
          };
          reader.readAsDataURL(file);
        });
      };

      const deletePhoto = (itemId, photoIndex) => {
        setPhotos(prev => ({
          ...prev,
          [itemId]: prev[itemId].filter((_, idx) => idx !== photoIndex)
        }));
      };

      // FIX #1: Calculate totals properly including checked items
      const calculateTotals = () => {
        const parseValue = (val) => {
          if (!val) return 0;
          const str = String(val).replace(/[$,]/g, '');
          return parseFloat(str) || 0;
        };

        const totalScheduled = items.reduce((sum, item) => sum + parseValue(item.scheduledValue), 0);
        const totalWorkCompleted = items.reduce((sum, item) => sum + parseValue(item.workCompleted), 0);
        
        // FIX: Count observable work from CHECKED items only
        const observableWork = items
          .filter(item => item.completed === true)
          .reduce((sum, item) => sum + parseValue(item.workCompleted), 0);
        
        const verifiedCount = items.filter(item => item.completed).length;
        const pendingCount = items.filter(item => !item.completed).length;

        return {
          totalScheduled,
          totalWorkCompleted,
          observableWork,
          verifiedCount,
          pendingCount
        };
      };

      // FIX #2 & #3: Generate PDF report with only verified items
      const generateReport = async () => {
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 20;
        let yPos = margin;

        const checkPageBreak = (neededSpace) => {
          if (yPos + neededSpace > pageHeight - margin) {
            doc.addPage();
            yPos = margin;
            return true;
          }
          return false;
        };

        // Header
        doc.setFontSize(22);
        doc.setTextColor(37, 99, 235);
        doc.text('Construction Observation Report', margin, yPos);
        yPos += 12;

        // Project Info Box
        doc.setFillColor(243, 244, 246);
        doc.rect(margin, yPos, pageWidth - 2 * margin, 50, 'F');
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        yPos += 8;
        doc.text(`Project Name: ${project.name || 'N/A'}`, margin + 5, yPos);
        yPos += 7;
        doc.text(`Pay Application Date: ${project.payAppDate}`, margin + 5, yPos);
        yPos += 7;
        doc.text(`Pay App Period: ${project.periodStart || 'N/A'} to ${project.periodEnd || 'N/A'}`, margin + 5, yPos);
        yPos += 7;
        doc.text(`Observation Date: ${project.observationDate}`, margin + 5, yPos);
        yPos += 7;
        doc.text(`Report Generated: ${new Date().toLocaleString()}`, margin + 5, yPos);
        yPos += 15;

        // Summary Statistics
        const totals = calculateTotals();
        
        checkPageBreak(40);
        doc.setFillColor(219, 234, 254);
        doc.rect(margin, yPos, pageWidth - 2 * margin, 35, 'F');
        
        doc.setFontSize(12);
        doc.setTextColor(30, 64, 175);
        yPos += 8;
        doc.text('Summary', margin + 5, yPos);
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        yPos += 7;
        doc.text(`Total Scheduled Value: $${totals.totalScheduled.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, margin + 5, yPos);
        yPos += 6;
        doc.text(`Total Work This Period: $${totals.totalWorkCompleted.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, margin + 5, yPos);
        yPos += 6;
        doc.text(`Observable Work (Verified): $${totals.observableWork.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, margin + 5, yPos);
        yPos += 6;
        doc.text(`Items Verified: ${totals.verifiedCount} | Pending: ${totals.pendingCount}`, margin + 5, yPos);
        yPos += 15;

        // FIX: Only include VERIFIED items in the report
        const verifiedItems = items.filter(item => item.completed === true);
        
        if (verifiedItems.length === 0) {
          checkPageBreak(20);
          doc.setFontSize(12);
          doc.setTextColor(185, 28, 28);
          doc.text('No items have been verified yet.', margin, yPos);
        } else {
          checkPageBreak(15);
          doc.setFontSize(14);
          doc.setTextColor(37, 99, 235);
          doc.text('Verified Work Items', margin, yPos);
          yPos += 10;

          for (const item of verifiedItems) {
            checkPageBreak(60);

            doc.setFillColor(239, 246, 255);
            const itemBoxHeight = 45;
            doc.rect(margin, yPos, pageWidth - 2 * margin, itemBoxHeight, 'F');
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');
            yPos += 8;
            const descText = item.description || 'Untitled Item';
            doc.text(descText.substring(0, 70), margin + 5, yPos);
            doc.setFont(undefined, 'normal');
            
            doc.setFontSize(10);
            doc.setTextColor(22, 163, 74);
            yPos += 6;
            doc.text('âœ“ Verified & Completed', margin + 5, yPos);
            
            doc.setTextColor(0, 0, 0);
            yPos += 7;
            doc.text(`Scheduled Value: $${item.scheduledValue || '0.00'}`, margin + 5, yPos);
            doc.text(`Work Completed: $${item.workCompleted || '0.00'}`, pageWidth / 2, yPos);
            
            yPos += 6;
            doc.text(`Percent Complete: ${item.percentComplete || '0'}%`, margin + 5, yPos);
            const photoCount = photos[item.id] ? photos[item.id].length : 0;
            doc.text(`Photos Captured: ${photoCount}`, pageWidth / 2, yPos);
            
            yPos += 10;

            if (notes[item.id]) {
              checkPageBreak(25);
              doc.setFillColor(254, 243, 199);
              const notesLines = doc.splitTextToSize(notes[item.id], pageWidth - 2 * margin - 10);
              const notesHeight = Math.min(notesLines.length * 5 + 8, 40);
              doc.rect(margin, yPos, pageWidth - 2 * margin, notesHeight, 'F');
              
              doc.setFontSize(9);
              doc.setFont(undefined, 'bold');
              yPos += 6;
              doc.text('Observation Notes:', margin + 5, yPos);
              doc.setFont(undefined, 'normal');
              yPos += 5;
              doc.text(notesLines.slice(0, 6), margin + 5, yPos);
              yPos += notesHeight - 5;
            }

            if (photos[item.id] && photos[item.id].length > 0) {
              checkPageBreak(70);
              yPos += 5;
              doc.setFontSize(10);
              doc.setFont(undefined, 'bold');
              doc.text('Verification Photos:', margin + 5, yPos);
              doc.setFont(undefined, 'normal');
              yPos += 7;
              
              const photosToShow = photos[item.id].slice(0, 4);
              let xPos = margin + 5;
              
              for (let i = 0; i < photosToShow.length; i++) {
                const photo = photosToShow[i];
                try {
                  const imgWidth = 40;
                  const imgHeight = 30;
                  
                  if (i === 2) {
                    xPos = margin + 5;
                    yPos += imgHeight + 5;
                    checkPageBreak(imgHeight + 10);
                  }
                  
                  doc.addImage(photo.url, 'JPEG', xPos, yPos, imgWidth, imgHeight);
                  
                  doc.setFontSize(7);
                  doc.text(photo.date, xPos, yPos + imgHeight + 3);
                  
                  xPos += imgWidth + 5;
                } catch (err) {
                  console.error('Error adding photo to PDF:', err);
                }
              }
              
              if (photosToShow.length > 2) {
                yPos += 40;
              } else {
                yPos += 35;
              }
            }

            yPos += 15;
          }
        }

        const totalPages = doc.internal.pages.length - 1;
        for (let i = 1; i <= totalPages; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.setTextColor(128, 128, 128);
          doc.text(
            `Page ${i} of ${totalPages} | Construction Observation Report | ${project.name || 'Project'}`,
            pageWidth / 2,
            pageHeight - 10,
            { align: 'center' }
          );
        }

        const fileName = `Construction_Observation_${project.name.replace(/\s+/g, '_')}_${project.payAppDate}.pdf`;
        doc.save(fileName);
      };

      const totals = calculateTotals();

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
          <div className="max-w-4xl mx-auto">
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <div className="flex items-center gap-3 mb-6">
                <FileText className="w-8 h-8 text-blue-600" />
                <h1 className="text-3xl font-bold text-gray-800">Construction Observation</h1>
              </div>

              <div className="space-y-4 mb-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                  <input
                    type="text"
                    placeholder="Enter project name"
                    value={project.name}
                    onChange={(e) => setProject({...project, name: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Pay App Date</label>
                    <input
                      type="date"
                      value={project.payAppDate}
                      onChange={(e) => setProject({...project, payAppDate: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Observation Date</label>
                    <input
                      type="date"
                      value={project.observationDate}
                      onChange={(e) => setProject({...project, observationDate: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Pay App Period</label>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <input
                        type="date"
                        placeholder="Period Start"
                        value={project.periodStart}
                        onChange={(e) => setProject({...project, periodStart: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                      <p className="text-xs text-gray-500 mt-1">Period Start</p>
                    </div>
                    <div>
                      <input
                        type="date"
                        placeholder="Period End"
                        value={project.periodEnd}
                        onChange={(e) => setProject({...project, periodEnd: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                      <p className="text-xs text-gray-500 mt-1">Period End</p>
                    </div>
                  </div>
                </div>
              </div>

              <div className="bg-blue-50 border-2 border-dashed border-blue-300 rounded-lg p-6 mb-4">
                <div className="text-center">
                  <FileUp className="w-12 h-12 text-blue-600 mx-auto mb-3" />
                  <h3 className="text-lg font-semibold text-gray-800 mb-2">Upload AIA Pay Application PDF</h3>
                  <p className="text-sm text-gray-600 mb-4">Upload your pay app PDF to automatically extract line items and project info</p>
                  <input
                    ref={pdfInputRef}
                    type="file"
                    accept="application/pdf"
                    onChange={handlePdfUpload}
                    className="hidden"
                  />
                  <button
                    onClick={() => pdfInputRef.current && pdfInputRef.current.click()}
                    disabled={uploadingPdf}
                    className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed"
                  >
                    {uploadingPdf ? 'Processing PDF...' : 'Choose PDF File'}
                  </button>
                </div>
                
                {pdfError && (
                  <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div className="flex items-start gap-2">
                      <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
                      <div>
                        <p className="text-red-800 font-semibold">Error extracting PDF:</p>
                        <p className="text-red-700 text-sm mt-1">{pdfError}</p>
                      </div>
                    </div>
                  </div>
                )}
                
                {extractionInstructions && (
                  <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p className="text-yellow-800 text-sm whitespace-pre-line">{extractionInstructions}</p>
                  </div>
                )}
              </div>

              <div className="flex items-center gap-3 mb-4">
                <div className="flex-1 h-px bg-gray-300"></div>
                <span className="text-gray-500 text-sm">OR</span>
                <div className="flex-1 h-px bg-gray-300"></div>
              </div>

              <div className="flex gap-3">
                <button
                  onClick={addItem}
                  className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                >
                  <Plus className="w-5 h-5" />
                  Add Single Item
                </button>
                <button
                  onClick={() => setShowBulkAdd(!showBulkAdd)}
                  className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                >
                  <Upload className="w-5 h-5" />
                  Quick Add Multiple Items
                </button>
              </div>

              {showBulkAdd && (
                <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                  <h3 className="font-semibold text-gray-800 mb-2">Quick Add Multiple Items</h3>
                  <p className="text-sm text-gray-600 mb-3">
                    Paste line items (one per line). Format: <code className="bg-white px-2 py-1 rounded text-xs">Description | Scheduled | Completed | %</code>
                    <br />
                    Example: <code className="bg-white px-2 py-1 rounded text-xs">Concrete Foundation | 50000.00 | 25000.00 | 50</code>
                  </p>
                  <textarea
                    value={bulkText}
                    onChange={(e) => setBulkText(e.target.value)}
                    placeholder="General Conditions | 20000.00 | 20000.00 | 100&#10;Site Work | 5000.00 | 5000.00 | 100"
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg mb-3 font-mono text-sm"
                    rows="10"
                  />
                  <div className="flex gap-2">
                    <button
                      onClick={parseBulkText}
                      className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                    >
                      Add Items
                    </button>
                    <button
                      onClick={() => {setShowBulkAdd(false); setBulkText('');}}
                      className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              )}
            </div>

            {items.length > 0 && (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 className="text-xl font-bold text-gray-800 mb-4">Summary</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div className="bg-blue-50 p-4 rounded-lg">
                    <div className="text-sm text-gray-600 mb-1">Total Scheduled</div>
                    <div className="text-2xl font-bold text-blue-700">
                      ${totals.totalScheduled.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                  </div>
                  <div className="bg-purple-50 p-4 rounded-lg">
                    <div className="text-sm text-gray-600 mb-1">Work This Period</div>
                    <div className="text-2xl font-bold text-purple-700">
                      ${totals.totalWorkCompleted.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                  </div>
                  <div className="bg-green-50 p-4 rounded-lg">
                    <div className="text-sm text-gray-600 mb-1">Observable Work</div>
                    <div className="text-2xl font-bold text-green-700">
                      ${totals.observableWork.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                    <div className="text-xs text-gray-500 mt-1">From {totals.verifiedCount} verified items</div>
                  </div>
                  <div className="bg-orange-50 p-4 rounded-lg">
                    <div className="text-sm text-gray-600 mb-1">Status</div>
                    <div className="text-lg font-bold text-orange-700">
                      {totals.verifiedCount} Verified
                    </div>
                    <div className="text-sm text-gray-600">
                      {totals.pendingCount} Pending
                    </div>
                  </div>
                </div>
              </div>
            )}

            {items.map((item) => (
              <div key={item.id} className="bg-white rounded-lg shadow-lg p-6 mb-4">
                <div className="flex items-start justify-between mb-4">
                  <div className="flex-1">
                    <input
                      type="text"
                      placeholder="Work Description (e.g., Concrete Foundation)"
                      value={item.description}
                      onChange={(e) => updateItem(item.id, 'description', e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-3 text-lg font-semibold"
                    />
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                      <div>
                        <label className="block text-xs font-medium text-gray-600 mb-1">Scheduled Value</label>
                        <input
                          type="text"
                          placeholder="$0.00"
                          value={item.scheduledValue}
                          onChange={(e) => updateItem(item.id, 'scheduledValue', e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>
                      <div>
                        <label className="block text-xs font-medium text-gray-600 mb-1">Work Completed</label>
                        <input
                          type="text"
                          placeholder="$0.00"
                          value={item.workCompleted}
                          onChange={(e) => updateItem(item.id, 'workCompleted', e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>
                      <div>
                        <label className="block text-xs font-medium text-gray-600 mb-1">% Complete</label>
                        <input
                          type="text"
                          placeholder="0%"
                          value={item.percentComplete}
                          onChange={(e) => updateItem(item.id, 'percentComplete', e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>
                    </div>
                  </div>
                  <button
                    onClick={() => deleteItem(item.id)}
                    className="ml-4 p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                  >
                    <Trash2 className="w-5 h-5" />
                  </button>
                </div>

                <div className="flex items-center gap-2 mb-4 p-3 bg-gray-50 rounded-lg">
                  <input
                    type="checkbox"
                    id={`complete-${item.id}`}
                    checked={item.completed}
                    onChange={(e) => updateItem(item.id, 'completed', e.target.checked)}
                    className="w-5 h-5 text-green-600 rounded focus:ring-2 focus:ring-green-500"
                  />
                  <label htmlFor={`complete-${item.id}`} className="flex items-center gap-2 cursor-pointer">
                    <CheckCircle className={`w-5 h-5 ${item.completed ? 'text-green-600' : 'text-gray-400'}`} />
                    <span className="text-gray-700 font-medium">Work Verified & Complete</span>
                  </label>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      <Camera className="w-4 h-4 inline mr-2" />
                      Verification Photos
                    </label>
                    <div className="flex gap-2 mb-3">
                      <label className="flex-1 cursor-pointer">
                        <input
                          type="file"
                          accept="image/*"
                          multiple
                          capture="environment"
                          onChange={(e) => handlePhotoCapture(e, item.id)}
                          className="hidden"
                        />
                        <div className="flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-semibold">
                          <Camera className="w-4 h-4" />
                          Take Photo
                        </div>
                      </label>
                      <label className="flex-1 cursor-pointer">
                        <input
                          type="file"
                          accept="image/*"
                          multiple
                          onChange={(e) => handlePhotoCapture(e, item.id)}
                          className="hidden"
                        />
                        <div className="flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-semibold">
                          <Upload className="w-4 h-4" />
                          Select Photos
                        </div>
                      </label>
                    </div>
                    {photos[item.id] && photos[item.id].length > 0 && (
                      <div className="mt-3 grid grid-cols-2 gap-2">
                        {photos[item.id].map((photo, idx) => (
                          <div key={idx} className="relative group">
                            <img 
                              src={photo.url} 
                              alt={`Photo ${idx + 1}`}
                              className="w-full h-32 object-cover rounded-lg border border-gray-300"
                            />
                            <button
                              onClick={() => deletePhoto(item.id, idx)}
                              className="absolute top-1 right-1 p-1 bg-red-500 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                            <p className="text-xs text-gray-500 mt-1">{photo.date}</p>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      <Mic className="w-4 h-4 inline mr-2" />
                      Observation Notes
                    </label>
                    <textarea
                      placeholder="Add observations, concerns, or voice note transcriptions..."
                      value={notes[item.id] || ''}
                      onChange={(e) => setNotes({...notes, [item.id]: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      rows="4"
                    />
                  </div>
                </div>
              </div>
            ))}

            {items.length > 0 && (
              <div className="bg-white rounded-lg shadow-lg p-6">
                <button
                  onClick={generateReport}
                  className="w-full flex items-center justify-center gap-2 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold"
                >
                  <Download className="w-5 h-5" />
                  Generate PDF Report for Bank
                </button>
                <p className="text-xs text-gray-500 text-center mt-2">
                  Report will only include verified items (checked boxes)
                </p>
              </div>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(ConstructionObservationApp));
  </script>
</body>
</html>
